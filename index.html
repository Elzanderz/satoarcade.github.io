<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SATO ARCADE</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <!-- Font: Noto Sans Thai (Primary) + Chakra Petch (Tech) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&family=Chakra+Petch:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Noto Sans Thai"', 'sans-serif'],
                        tech: ['"Chakra Petch"', 'sans-serif']
                    },
                    colors: { 
                        crypto: {
                            bg: '#050508',
                            primary: '#6366f1',
                            accent: '#00f3ff',
                            success: '#10b981',
                            danger: '#ef4444',
                            gold: '#fbbf24'
                        }
                    },
                    animation: {
                        'pulse-fast': 'pulse 0.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        glow: {
                            'from': { boxShadow: '0 0 5px #00f3ff, 0 0 10px #00f3ff' },
                            'to': { boxShadow: '0 0 20px #00f3ff, 0 0 30px #00f3ff' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            font-family: 'Noto Sans Thai', sans-serif; 
            background-color: #020204;
            color: #e2e8f0;
            overflow-x: hidden;
            touch-action: manipulation;
        }
        
        .web3-bg {
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            position: fixed; inset: 0; z-index: 0; pointer-events: none;
            perspective: 1000px;
        }

        .glass-panel {
            background: rgba(18, 18, 24, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3), inset 0 0 0 1px rgba(255, 255, 255, 0.05);
            border-radius: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .game-card {
            background: linear-gradient(180deg, rgba(30, 30, 40, 0.8) 0%, rgba(10, 10, 15, 0.9) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        .game-card:hover {
            transform: translateY(-5px);
            border-color: #00f3ff;
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.2);
        }

        .tech-input {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #333;
            color: #00f3ff;
            font-family: 'Chakra Petch', sans-serif;
            letter-spacing: 1px;
            transition: all 0.3s;
        }
        .tech-input:focus {
            border-color: #00f3ff;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
            outline: none;
        }

        .text-glow { text-shadow: 0 0 10px rgba(0, 243, 255, 0.7); }
        .dice-face {
            width: 45px; height: 45px; display: flex; justify-content: center; align-items: center;
            border-radius: 8px; font-weight: bold; font-size: 24px;
            background: #1a1a20; border: 1px solid #333; box-shadow: inset 0 0 10px #000;
        }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #050508; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #00f3ff; }
    </style>
</head>
<body class="min-h-screen relative selection:bg-crypto-accent selection:text-black">
    <div class="web3-bg"></div>
    <div id="root" class="relative z-10"></div>

    <script type="text/babel">
        // --- CONFIG ---
        let firebaseConfig = {
            apiKey: "AIzaSyCXqkbLFskjFsKkpsf2FBucRiagg5XB8o4",
            authDomain: "bingo-sato.firebaseapp.com",
            projectId: "bingo-sato",
            storageBucket: "bingo-sato.firebasestorage.app",
            messagingSenderId: "348261448088",
            appId: "1:348261448088:web:61c19861c88b3c5094d3ed",
            measurementId: "G-VDFPGKGN8Q"
        };
        
        if (typeof __firebase_config !== 'undefined') firebaseConfig = JSON.parse(__firebase_config);
        
        // --- FIXED APP ID (Dynamic) ---
        let APP_ID = 'sato-arcade-main-db';
        if (typeof __app_id !== 'undefined') APP_ID = __app_id;

        const HOST_PASSWORD = "hostsato56";
        const BGM_URL = "https://cdn.pixabay.com/download/audio/2022/03/15/audio_73663a8301.mp3"; 

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- CONSTANTS ---
        const INITIAL_CREDITS = 500;
        const DEFAULT_PRICE = 50;

        const SHOP_ITEMS = [
            { id: 'room_ticket', name: '‡∏ï‡∏±‡πã‡∏ß‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á', type: 'item', price: 500, css: 'text-yellow-400 border-yellow-500' },
            { id: 'frame_default', name: '‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', type: 'frame', price: 0, css: 'border-2 border-slate-600' },
            { id: 'frame_gold', name: '‡∏Å‡∏£‡∏≠‡∏ö‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥', type: 'frame', price: 500, css: 'border-2 border-yellow-400 shadow-[0_0_15px_#fbbf24] bg-yellow-900/20' },
            { id: 'frame_neon', name: '‡∏Å‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡∏≠‡∏≠‡∏ô', type: 'frame', price: 1000, css: 'border-2 border-cyan-400 shadow-[0_0_15px_#22d3ee] bg-cyan-900/20' },
            { id: 'title_default', name: '‡∏™‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥', type: 'title', price: 0, css: 'text-slate-400' },
            { id: 'title_gold', name: '‡∏™‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏≠‡∏á', type: 'title', price: 800, css: 'text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-yellow-600 font-bold' },
        ];

        // --- ICONS ---
        const Icons = {
            User: ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Crown: ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></svg>,
            Cube: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>,
            Bingo: ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/><path d="M9 3v18"/><path d="M15 3v18"/></svg>,
            Dice: ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="4" y="4" width="16" height="16" rx="2"/><circle cx="9" cy="9" r="1"/><circle cx="15" cy="15" r="1"/></svg>,
            Run: ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 2L11 13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Home: ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            Music: ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>,
            MusicOff: ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="1" y1="1" x2="23" y2="23"/><path d="M9 9v3.14A3 3 0 0 0 6 18c1.66 0 3-1.34 3-3v-2"/><path d="M21 16a3 3 0 0 0-3-3v-3l-4.08-1.36"/></svg>,
            Shopping: ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>,
            Lock: ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Door: ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>,
            Send: ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Logout: ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
            Edit: ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            Wallet: ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/><line x1="12" x2="12" y1="15" y2="15"/></svg>,
            Diamond: ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 3h12l4 6-10 13L2 9z"/></svg>,
            ArrowRight: ({className}) => <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
        };

        // --- COMPONENTS ---
        
        function LogoDisplay({ small }) {
            return (
                <div className={`flex flex-col items-center justify-center ${small ? 'mb-4' : 'mb-10 animate-float'}`}>
                    <div className="relative group">
                        <div className={`${small ? 'h-16 w-16' : 'h-32 w-32'} bg-black/80 border border-crypto-primary rounded-xl flex items-center justify-center shadow-[0_0_30px_rgba(99,102,241,0.5)] relative overflow-hidden`}>
                            <div className="absolute inset-0 bg-gradient-to-br from-crypto-primary/20 to-transparent"></div>
                            <Icons.Cube className={`${small ? 'w-8 h-8' : 'w-16 h-16'} text-crypto-primary relative z-10`} />
                        </div>
                    </div>
                    {!small && (
                        <div className="mt-6 text-center">
                            <h1 className="text-4xl font-tech font-bold italic tracking-tighter text-white drop-shadow-lg">SATO <span className="text-crypto-primary">ARCADE LOGIN</span></h1>
                            <p className="text-[10px] text-slate-400 font-mono tracking-[0.5em] mt-2 uppercase">WEB3 GAMING PROTOCOL</p>
                        </div>
                    )}
                </div>
            );
        }

        // --- SLIDER BUTTON ---
        function SliderButton({ onComplete, text, disabled, loading, resetTrigger }) {
            const [isDragging, setIsDragging] = useState(false);
            const [sliderX, setSliderX] = useState(0);
            const containerRef = useRef(null);
            const [completed, setCompleted] = useState(false);

            useEffect(() => {
                if (resetTrigger > 0) {
                    setCompleted(false); setSliderX(0); setIsDragging(false);
                }
            }, [resetTrigger]);

            const handleStart = (e) => { if (!disabled && !completed && !loading) setIsDragging(true); };

            const handleMove = useCallback((e) => {
                if (!isDragging || completed) return;
                const container = containerRef.current;
                if(!container) return;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const rect = container.getBoundingClientRect();
                let x = clientX - rect.left - 28; 
                const max = rect.width - 56; 
                if (x < 0) x = 0; if (x > max) x = max;
                setSliderX(x);
                if (x >= max - 2) { setIsDragging(false); setCompleted(true); onComplete(); }
            }, [isDragging, completed, onComplete]);

            const handleEnd = useCallback(() => { if (!isDragging) return; setIsDragging(false); if (!completed) setSliderX(0); }, [isDragging, completed]);

            useEffect(() => {
                if (isDragging) {
                    document.addEventListener('mousemove', handleMove); document.addEventListener('mouseup', handleEnd);
                    document.addEventListener('touchmove', handleMove); document.addEventListener('touchend', handleEnd);
                } else {
                    document.removeEventListener('mousemove', handleMove); document.removeEventListener('mouseup', handleEnd);
                    document.removeEventListener('touchmove', handleMove); document.removeEventListener('touchend', handleEnd);
                }
                return () => {
                    document.removeEventListener('mousemove', handleMove); document.removeEventListener('mouseup', handleEnd);
                    document.removeEventListener('touchmove', handleMove); document.removeEventListener('touchend', handleEnd);
                }
            }, [isDragging, handleMove, handleEnd]);

            return (
                <div ref={containerRef} className={`relative w-full h-14 bg-black/40 border border-white/10 rounded-full overflow-hidden select-none ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}>
                    <div className="absolute inset-0 flex items-center justify-center text-sm font-tech tracking-[0.2em] text-white/50 pointer-events-none animate-pulse">
                        {loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...' : (completed ? '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!' : text)}
                    </div>
                    <div className="absolute top-0 left-0 h-full bg-crypto-primary/20 transition-all duration-75 ease-linear" style={{ width: `${sliderX + 56}px` }} />
                    <div onMouseDown={handleStart} onTouchStart={handleStart} className="absolute top-1 left-1 w-12 h-12 bg-white rounded-full shadow-lg cursor-grab flex items-center justify-center text-crypto-primary z-10 transition-transform active:scale-95 hover:scale-105" style={{ transform: `translateX(${sliderX}px)` }}>
                        {loading ? <div className="animate-spin rounded-full h-5 w-5 border-2 border-crypto-primary border-t-transparent"></div> : <Icons.ArrowRight className="w-6 h-6"/>}
                    </div>
                </div>
            );
        }

        // --- AUTH ---
        function AuthScreen({ onJoin, db }) {
            const [mode, setMode] = useState('login'); 
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [resetSlider, setResetSlider] = useState(0); 

            const processAuth = async () => {
                setError('');
                if(!username || !password) { setResetSlider(p => p + 1); return setError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); }
                const cleanId = username.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
                if (cleanId.length < 3) { setResetSlider(p => p + 1); return setError("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ï‡∏±‡∏ß"); }

                setLoading(true);
                try {
                    let role = 'player';
                    let isAdminLogin = false;
                    if(username === 'admin' && password === HOST_PASSWORD) { role = 'host'; isAdminLogin = true; }
                    if (!db) throw new Error("‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà");

                    const userRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bingo_users').doc(cleanId);
                    const doc = await userRef.get();

                    if (mode === 'register') {
                        if (doc.exists) throw new Error("‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß");
                         await userRef.set({
                            username: username, password: password, role: isAdminLogin ? 'host' : 'player',
                            credits: isAdminLogin ? 999999 : INITIAL_CREDITS, level: 1, xp: 0,
                            inventory: ['frame_default', 'title_default'], equipped: { frame: 'frame_default', title: 'title_default' },
                            isVip: isAdminLogin, joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        onJoin(cleanId, username, isAdminLogin ? 'host' : 'player');
                    } else {
                        if (!doc.exists) {
                             if (isAdminLogin) {
                                await userRef.set({
                                    username: 'ADMIN', password: HOST_PASSWORD, role: 'host', credits: 999999, level: 99, xp: 0, isVip: true, inventory: [], equipped: {}, joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                             } else { throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Å‡πà‡∏≠‡∏ô)"); }
                        }
                        const data = doc.exists ? doc.data() : { password: HOST_PASSWORD };
                        if (!isAdminLogin && data.password !== password) throw new Error("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                        onJoin(cleanId, data.username || username, data.role || role);
                    }
                } catch(e) { setError(e.message); setLoading(false); setResetSlider(p => p + 1); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="glass-panel p-8 max-w-sm w-full text-center border-t-2 border-neon-blue shadow-[0_0_50px_rgba(0,243,255,0.2)]">
                        <div className="mb-6"><LogoDisplay /></div>
                        <div className="flex bg-black/40 rounded-xl p-1.5 mb-8 border border-white/10">
                            <button onClick={() => setMode('login')} className={`flex-1 py-2.5 text-xs font-bold rounded-lg transition-all ${mode === 'login' ? 'bg-white text-black shadow-lg' : 'text-slate-400 hover:text-white'}`}>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                            <button onClick={() => setMode('register')} className={`flex-1 py-2.5 text-xs font-bold rounded-lg transition-all ${mode === 'register' ? 'bg-white text-black shadow-lg' : 'text-slate-400 hover:text-white'}`}>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà</button>
                        </div>
                        <div className="space-y-5">
                            <div className="relative group"><input className="tech-input w-full px-5 py-4 rounded-2xl text-sm placeholder-slate-500 pl-12" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" value={username} onChange={e=>setUsername(e.target.value)} /><div className="absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-500 group-focus-within:text-crypto-primary"><Icons.User className="w-5 h-5"/></div></div>
                            <div className="relative group"><input className="tech-input w-full px-5 py-4 rounded-2xl text-sm placeholder-slate-500 pl-12" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" value={password} onChange={e=>setPassword(e.target.value)} /><div className="absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-500 group-focus-within:text-crypto-primary"><Icons.Lock className="w-5 h-5"/></div></div>
                            {error && <div className="p-3 bg-red-500/10 border border-red-500/20 text-red-400 text-xs rounded-xl flex items-center justify-center gap-2 animate-pulse">‚ö†Ô∏è {error}</div>}
                            {mode === 'login' ? (<SliderButton onComplete={processAuth} text="‡∏™‡πÑ‡∏•‡∏î‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö" loading={loading} resetTrigger={resetSlider} />) : (<button onClick={processAuth} disabled={loading} className="w-full bg-white hover:bg-slate-200 text-black font-bold py-4 rounded-2xl shadow-lg transition-all font-tech tracking-widest text-sm">{loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ...' : '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ'}</button>)}
                        </div>
                    </div>
                </div>
            );
        }

        // --- SUB APPS ---
        function InventoryModal({ userData, userProfile, db, onClose }) {
            const equipItem = async (type, id) => { await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bingo_users').doc(userProfile.uid).update({ [`equipped.${type}`]: id }); };
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4">
                    <div className="glass-panel w-full max-w-lg overflow-hidden flex flex-col border border-crypto-primary/30">
                        <div className="p-4 border-b border-white/10 flex justify-between bg-black/40"><h2 className="text-xl font-tech font-bold text-crypto-accent">INVENTORY</h2><button onClick={onClose} className="text-red-500">[X]</button></div>
                        <div className="p-4 grid grid-cols-2 gap-3 max-h-[70vh] overflow-y-auto">{SHOP_ITEMS.filter(i => userData.inventory.includes(i.id)).map(item => (<div key={item.id} className="p-3 bg-white/5 rounded border border-white/10 flex flex-col items-center"><div className="text-xs text-slate-300 mb-2">{item.name}</div><button onClick={() => equipItem(item.type, item.id)} className="px-3 py-1 bg-crypto-primary/20 text-crypto-primary border border-crypto-primary/50 rounded text-[10px]">{(userData.equipped[item.type] === item.id) ? 'EQUIPPED' : 'EQUIP'}</button></div>))}</div>
                    </div>
                </div>
            );
        }
        function ShopModal({ userData, userProfile, db, currentAppId, onClose, updateCredits }) {
            const [items, setItems] = useState(SHOP_ITEMS);
            const buyItem = async (item) => {
                if (userData.credits < item.price) return alert('‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠!');
                if (confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ã‡∏∑‡πâ‡∏≠ ${item.name}?`)) {
                    await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bingo_users').doc(userProfile.uid).update({ credits: firebase.firestore.FieldValue.increment(-item.price), inventory: firebase.firestore.FieldValue.arrayUnion(item.id) });
                    alert(`‡∏ã‡∏∑‡πâ‡∏≠ ${item.name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                }
            };
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4">
                    <div className="glass-panel w-full max-w-2xl max-h-[85vh] flex flex-col overflow-hidden border border-white/10 shadow-2xl">
                        <div className="p-6 border-b border-white/5 flex justify-between items-center bg-white/5"><div><h2 className="text-xl font-tech font-bold text-white flex items-center gap-3"><Icons.Shopping className="w-5 h-5"/> ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏≠‡πÄ‡∏ó‡∏°</h2></div><div className="text-right"><div className="text-xl font-mono font-bold text-white">{userData.credits.toLocaleString()} ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</div><button onClick={onClose} className="text-[10px] text-white/50 hover:text-white uppercase tracking-widest mt-1 bg-white/5 px-3 py-1 rounded-full hover:bg-white/10 transition-all">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button></div></div>
                        <div className="flex-1 overflow-y-auto p-6 grid grid-cols-1 md:grid-cols-2 gap-4">{items.map(item => { const isOwned = (userData.inventory || []).includes(item.id); return (<div key={item.id} className="bg-white/5 p-5 rounded-3xl border border-white/5 hover:border-crypto-accent/50 flex items-center justify-between group transition-all relative overflow-hidden"><div className="flex items-center gap-4 relative z-10">{item.type === 'frame' ? (<div className={`w-14 h-14 flex items-center justify-center bg-black/40 rounded-2xl ${item.css}`}><span className="text-[9px] text-slate-500 font-mono">‡∏£‡∏π‡∏õ</span></div>) : (<div className={`text-base ${item.css}`}>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</div>)}<div><div className="font-bold text-base text-slate-200 group-hover:text-crypto-accent transition-colors font-tech uppercase tracking-wide">{item.name}</div><div className="text-[11px] text-slate-400 font-mono mt-1">{item.price > 0 ? `${item.price} ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç` : '‡∏ü‡∏£‡∏µ'}</div></div></div><div className="relative z-10">{isOwned ? (<span className="text-xs text-green-400 font-mono">‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß</span>) : (<button onClick={() => buyItem(item)} className="px-5 py-2 bg-crypto-primary/20 border border-crypto-primary/30 text-white hover:bg-crypto-primary hover:shadow-glow rounded-xl text-[10px] font-bold uppercase tracking-wider transition-all">‡∏ã‡∏∑‡πâ‡∏≠</button>)}</div></div>); })}</div>
                    </div>
                </div>
            );
        }
        function Leaderboard({ users }) {
            const sortedUsers = [...users].sort((a,b) => (b.credits || 0) - (a.credits || 0)).slice(0, 10);
            return (
                <div className="glass-panel p-4 h-full flex flex-col">
                    <h3 className="font-tech text-gold text-lg mb-4 flex items-center gap-2"><Icons.Trophy className="text-yellow-500 w-5 h-5" /> RICHEST LIST</h3>
                    <div className="flex-1 overflow-y-auto space-y-2 custom-scroll pr-1">
                        {sortedUsers.map((u, i) => (<div key={u.id} className="flex items-center justify-between p-2 bg-black/40 rounded border border-white/5"><div className="flex items-center gap-3"><div className={`w-6 h-6 flex items-center justify-center font-bold text-xs rounded ${i===0?'bg-yellow-500 text-black':i===1?'bg-gray-400 text-black':i===2?'bg-orange-700 text-white':'bg-slate-800 text-slate-500'}`}>{i+1}</div><span className="text-sm font-mono text-slate-300">{u.username}</span></div><span className="text-xs text-crypto-accent font-bold">{u.credits?.toLocaleString()}</span></div>))}
                    </div>
                </div>
            );
        }
        function ChatRoom({ userProfile, db }) {
            const [msg, setMsg] = useState(''); const [chats, setChats] = useState([]); const dummyRef = useRef();
            useEffect(() => { const unsub = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bingo_chat').onSnapshot(s => { const allChats = s.docs.map(d => d.data()); allChats.sort((a,b) => (a.timestamp?.seconds||0) - (b.timestamp?.seconds||0)); setChats(allChats.slice(-20)); setTimeout(() => dummyRef.current?.scrollIntoView({ behavior: 'smooth' }), 100); }); return () => unsub(); }, []);
            const send = async (e) => { e.preventDefault(); if(!msg.trim()) return; await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bingo_chat').add({ user: userProfile.name, msg: msg.trim(), timestamp: firebase.firestore.FieldValue.serverTimestamp() }); setMsg(''); };
            return (
                <div className="glass-panel p-4 h-full flex flex-col">
                    <h3 className="font-tech text-crypto-primary text-lg mb-2 flex items-center gap-2"><Icons.Chat className="text-blue-400 w-5 h-5" /> LIVE CHAT</h3>
                    <div className="flex-1 overflow-y-auto space-y-2 mb-2 custom-scroll bg-black/20 p-2 rounded-lg h-32">
                        {chats.map((c, i) => (<div key={i} className="text-xs break-words"><span className="text-crypto-accent font-bold">{c.user}:</span> <span className="text-slate-300">{c.msg}</span></div>))}
                        <div ref={dummyRef}></div>
                    </div>
                    <form onSubmit={send} className="flex gap-2"><input value={msg} onChange={e=>setMsg(e.target.value)} className="flex-1 bg-black/50 border border-white/10 rounded px-2 py-1 text-sm text-white focus:border-crypto-primary outline-none" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." /><button type="submit" className="bg-crypto-primary text-white p-2 rounded hover:bg-indigo-600"><Icons.Send className="w-4 h-4" /></button></form>
                </div>
            );
        }
        function CyberRunner({ userData, updateCredits, onClose }) {
            const canvasRef = useRef(null); const [score, setScore] = useState(0); const [gameState, setGameState] = useState('start'); 
            useEffect(() => { if (gameState !== 'playing') return; const canvas = canvasRef.current; const ctx = canvas.getContext('2d'); let frames = 0, reqId; const player = { x: 40, y: 220, w: 30, h: 20, dy: 0, jump: -12, ground: 220, grounded: true }; let obstacles = []; let speed = 4;
                const loop = () => { frames++; ctx.clearRect(0, 0, 600, 300); ctx.strokeStyle = '#00f3ff'; ctx.beginPath(); ctx.moveTo(0, 240); ctx.lineTo(600, 240); ctx.stroke();
                    player.dy += 0.6; player.y += player.dy; if (player.y >= player.ground) { player.y = player.ground; player.dy = 0; player.grounded = true; }
                    ctx.fillStyle = '#00f3ff'; ctx.fillRect(player.x, player.y, player.w, player.h);
                    if (frames % Math.floor(1100/speed) === 0) { obstacles.push({ x: 600, y: 220, w: 20, h: 20 }); speed += 0.05; }
                    for(let i=0; i<obstacles.length; i++) { let obs = obstacles[i]; obs.x -= speed; ctx.fillStyle = '#ef4444'; ctx.fillRect(obs.x, obs.y, obs.w, obs.h); if (player.x < obs.x + obs.w && player.x + player.w > obs.x && player.y < obs.y + obs.h && player.y + player.h > obs.y) { setGameState('gameover'); cancelAnimationFrame(reqId); return; } if (obs.x + obs.w < 0) { obstacles.shift(); i--; setScore(s => s + 10); } }
                    ctx.fillStyle = '#fff'; ctx.font = '20px "Chakra Petch"'; ctx.fillText(`SCORE: ${score}`, 10, 30); reqId = requestAnimationFrame(loop);
                };
                reqId = requestAnimationFrame(loop); const jump = () => { if (player.grounded) { player.dy = player.jump; player.grounded = false; } }; window.addEventListener('keydown', jump); canvas.addEventListener('mousedown', jump); return () => { window.removeEventListener('keydown', jump); canvas.removeEventListener('mousedown', jump); cancelAnimationFrame(reqId); };
            }, [gameState]);
            return (<div className="glass-panel p-6 flex flex-col items-center justify-center h-full animate-in zoom-in"><div className="flex justify-between w-full mb-2"><h2 className="text-xl font-tech text-neon-blue flex items-center gap-2"><Icons.Run className="w-6 h-6"/> CYBER RUN 2.0</h2><button onClick={onClose} className="text-slate-400 text-xs">‡∏≠‡∏≠‡∏Å</button></div><div className="relative"><canvas ref={canvasRef} width="600" height="300" className="bg-black/60 rounded-lg border border-neon-blue/30 w-full max-w-[600px] shadow-[0_0_20px_rgba(0,243,255,0.2)] touch-none"></canvas>{gameState === 'start' && (<div className="absolute inset-0 flex flex-col items-center justify-center bg-black/70 backdrop-blur-sm rounded-lg"><button onClick={()=>{setScore(0); setGameState('playing')}} className="bg-neon-blue text-black font-bold py-2 px-8 rounded-full hover:scale-110 transition-transform">START</button></div>)}{gameState === 'gameover' && (<div className="absolute inset-0 flex flex-col items-center justify-center bg-red-900/80 backdrop-blur-sm rounded-lg"><h1 className="text-4xl font-bold text-white mb-2">CRASHED!</h1><p className="text-yellow-300 text-xl font-mono mb-4">SCORE: {score}</p><button onClick={async () => { await updateCredits(Math.floor(score/10)); onClose(); }} className="bg-white text-black font-bold py-2 px-6 rounded-full hover:bg-slate-200">‡∏£‡∏±‡∏ö {Math.floor(score/10)} ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</button></div>)}</div></div>);
        }
        function NamTaoPuPla({ userData, updateCredits, onClose }) {
            const sym = ["üéÉ", "ü¶Ä", "üêü", "üêì", "üç§", "üêØ"]; const [bets, setBets] = useState({}); const [res, setRes] = useState([0,0,0]); const [state, setState] = useState('bet'); 
            const addBet = (i) => { if(state !== 'bet') return; if(userData.credits < 10) return alert("‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠"); updateCredits(-10); setBets(prev => ({...prev, [i]: (prev[i]||0)+10})); }
            const roll = () => { if(Object.keys(bets).length === 0) return alert("‡∏ß‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô"); setState('rolling'); let c = 0; const iv = setInterval(() => { setRes([Math.floor(Math.random()*6), Math.floor(Math.random()*6), Math.floor(Math.random()*6)]); c++; if(c > 10) { clearInterval(iv); const final = [Math.floor(Math.random()*6), Math.floor(Math.random()*6), Math.floor(Math.random()*6)]; setRes(final); let win = 0; let hits = {}; final.forEach(x => hits[x] = (hits[x]||0)+1); Object.keys(bets).forEach(k => { if(hits[k]) win += bets[k] + (bets[k] * hits[k]); }); if(win > 0) { updateCredits(win); alert(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡πÑ‡∏î‡πâ ${win} ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç`); } setState('bet'); setBets({}); } }, 100); }
            return (<div className="glass-panel p-6 h-full flex flex-col items-center justify-center animate-in zoom-in"><div className="flex justify-between w-full mb-4"><h2 className="text-lg font-bold text-red-400">Nam Tao Pu Pla</h2><button onClick={onClose} className="text-xs text-slate-400">‡∏≠‡∏≠‡∏Å</button></div><div className="flex gap-4 mb-6 bg-black/40 p-4 rounded-xl border border-red-500/20">{res.map((r,i) => <div key={i} className="dice-face text-4xl">{sym[r]}</div>)}</div><div className="grid grid-cols-3 gap-3 w-full mb-6">{sym.map((s, i) => (<div key={i} onClick={()=>addBet(i)} className="bg-white/5 p-2 rounded border border-white/10 hover:border-red-400 cursor-pointer text-center relative group"><div className="text-3xl mb-1 group-hover:scale-110 transition-transform">{s}</div><div className="text-[10px] text-slate-400">BET 10</div>{bets[i] && <div className="absolute top-0 right-0 bg-yellow-500 text-black text-xs font-bold px-1 rounded-bl">{bets[i]}</div>}</div>))}</div><button onClick={roll} disabled={state!=='bet'} className="w-full py-3 bg-red-600 text-white font-bold rounded-xl disabled:opacity-50">{state==='rolling' ? 'ROLLING...' : 'ROLL DICE'}</button></div>);
        }
        function BingoLobby({ userProfile, userData, db, onClose, onJoinRoom }) {
            const [rooms, setRooms] = useState([]); const [showCreate, setShowCreate] = useState(false); const [newRoomName, setNewRoomName] = useState(''); const [newRoomPass, setNewRoomPass] = useState('');
            useEffect(() => { const unsub = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bingo_rooms').onSnapshot(s => { const allRooms = s.docs.map(d => ({id:d.id, ...d.data()})); allRooms.sort((a,b) => (b.timestamp?.seconds||0) - (a.timestamp?.seconds||0)); setRooms(allRooms); }); return () => unsub(); }, []);
            const createRoom = async () => { if(!newRoomName) return alert("‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á"); const hasTicket = (userData.inventory||[]).includes('room_ticket'); if(!userData.isVip) { if(!hasTicket) return alert("‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡πã‡∏ß‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á"); if(!confirm("‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡πã‡∏ß‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á 1 ‡πÉ‡∏ö?")) return; await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bingo_users').doc(userProfile.uid).update({ inventory: firebase.firestore.FieldValue.arrayRemove('room_ticket') }); } await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bingo_rooms').add({ name: newRoomName, password: newRoomPass, hostId: userProfile.uid, hostName: userData.username, currentNumber: null, history: [], timestamp: firebase.firestore.FieldValue.serverTimestamp() }); setShowCreate(false); };
            const joinRoom = (room) => { if(room.password) { const p = prompt("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:"); if(p !== room.password) return alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î"); } onJoinRoom(room.id); };
            return (<div className="glass-panel p-6 h-full flex flex-col animate-in fade-in"><div className="flex justify-between items-center mb-4"><button onClick={onClose} className="text-slate-400 hover:text-white text-xs flex items-center gap-1">‚Üê LOBBY</button><h2 className="text-lg font-bold text-neon-blue">BINGO ROOMS</h2><button onClick={()=>setShowCreate(true)} className="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-xs">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á</button></div>{showCreate && (<div className="mb-4 p-4 bg-white/5 rounded-xl border border-white/10"><input value={newRoomName} onChange={e=>setNewRoomName(e.target.value)} className="w-full bg-black/40 border border-white/10 rounded px-3 py-2 text-sm text-white mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á" /><input value={newRoomPass} onChange={e=>setNewRoomPass(e.target.value)} className="w-full bg-black/40 border border-white/10 rounded px-3 py-2 text-sm text-white mb-2" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" /><button onClick={createRoom} className="w-full bg-green-600 text-white py-1 rounded text-xs">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div>)}<div className="flex-1 overflow-y-auto space-y-2 custom-scroll">{rooms.map(room => (<div key={room.id} onClick={()=>joinRoom(room)} className="p-3 bg-white/5 border border-white/10 rounded-xl hover:border-neon-blue cursor-pointer flex justify-between items-center"><div><div className="font-bold text-slate-200">{room.name}</div><div className="text-[10px] text-slate-400">Host: {room.hostName}</div></div><div className="flex items-center gap-2">{room.password && <Icons.Lock className="w-3 h-3 text-red-400"/>}<span className="text-[10px] bg-white/10 px-2 py-1 rounded text-white">JOIN</span></div></div>))}</div></div>);
        }
        function UserProfile({ userData, userProfile, db, currentAppId, onClose }) {
            const [editName, setEditName] = useState(false); const [newName, setNewName] = useState(userData.username); const [shopItems, setShopItems] = useState(SHOP_ITEMS);
            const saveName = async () => { if(!newName.trim()) return; await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bingo_users').doc(userProfile.uid).update({ username: newName }); setEditName(false); };
            const equipItem = async (type, id) => { await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bingo_users').doc(userProfile.uid).update({ [`equipped.${type}`]: id }); };
            const getFrameStyle = (id) => SHOP_ITEMS.find(i => i.id === id)?.css || '';
            const getTitleStyle = (id) => SHOP_ITEMS.find(i => i.id === id)?.css || '';
            return (<div className="glass-panel p-6 h-full flex flex-col animate-in fade-in zoom-in"><button onClick={onClose} className="self-start mb-4 text-xs text-slate-400 hover:text-white flex items-center gap-1">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button><div className="flex flex-col items-center mb-6"><div className={`w-24 h-24 rounded-2xl flex items-center justify-center text-4xl font-tech font-bold text-white shadow-lg bg-black/40 mb-4 ${getFrameStyle(userData.equipped.frame)}`}>{userData.username.charAt(0).toUpperCase()}</div>{editName ? (<div className="flex gap-2"><input value={newName} onChange={e=>setNewName(e.target.value)} className="bg-black/50 border border-white/20 rounded px-2 py-1 text-white text-sm" /><button onClick={saveName} className="bg-green-600 px-3 rounded text-xs text-white">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>) : (<h2 className={`font-bold text-2xl font-tech tracking-wide flex items-center gap-2 ${getTitleStyle(userData.equipped.title)}`}>{userData.username} <button onClick={()=>setEditName(true)}><Icons.Edit className="w-4 h-4 text-slate-500 hover:text-white"/></button></h2>)}<div className="text-crypto-accent font-mono mt-1 text-sm">{userData.credits.toLocaleString()} ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç</div></div><div className="border-t border-white/10 pt-4"><h3 className="text-sm font-bold text-white mb-3">‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏∞‡∏™‡∏°</h3><div className="grid grid-cols-2 gap-3 max-h-64 overflow-y-auto custom-scroll">{SHOP_ITEMS.filter(i => (userData.inventory||[]).includes(i.id) && i.type !== 'item').map(item => (<div key={item.id} className="p-2 bg-white/5 rounded border border-white/10 flex flex-col items-center"><div className="text-[10px] text-slate-300 mb-1">{item.name}</div><button onClick={() => equipItem(item.type, item.id)} className={`px-2 py-1 rounded text-[10px] w-full ${userData.equipped[item.type] === item.id ? 'bg-green-600 text-white' : 'bg-slate-700 text-slate-300'}`}>{(userData.equipped[item.type] === item.id) ? '‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà' : '‡∏™‡∏ß‡∏°‡πÉ‡∏™‡πà'}</button></div>))}</div></div></div>);
        }
        function BingoRoom({ userProfile, userData, db, currentAppId, updateCredits, roomId, onLeave }) {
            const [gameState, setGameState] = useState(null); const [playerCard, setPlayerCard] = useState([]); const [hasClaimed, setHasClaimed] = useState(false); const [isAutoPlaying, setIsAutoPlaying] = useState(false); const autoPlayRef = useRef(null); const roomRef = useMemo(() => db.collection('artifacts').doc(currentAppId).collection('public').doc('data').collection('bingo_rooms').doc(roomId), [roomId]);
            useEffect(() => { const unsub = roomRef.onSnapshot(doc => { if (doc.exists) { const data = doc.data(); if(!data.history) data.history = []; setGameState(data); } }); return () => unsub(); }, [roomId]);
            const generateNumber = async () => { if (userProfile.uid !== gameState.hostId) return; const available = Array.from({length: 75}, (_, i) => i + 1).filter(n => !gameState.history.includes(n)); if (available.length === 0) { setIsAutoPlaying(false); return; } const newNum = available[Math.floor(Math.random() * available.length)]; await roomRef.update({ currentNumber: newNum, history: [newNum, ...gameState.history] }); };
            const toggleAutoPlay = () => { if (isAutoPlaying) setIsAutoPlaying(false); else { setIsAutoPlaying(true); generateNumber(); } };
            useEffect(() => { if (isAutoPlaying) autoPlayRef.current = setInterval(generateNumber, 3500); else clearInterval(autoPlayRef.current); return () => clearInterval(autoPlayRef.current); }, [isAutoPlaying]);
            const buyCard = async () => { if (userData.credits < 50) return alert("‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠"); await updateCredits(-50); const card = []; const cols = [{s:1,e:15}, {s:16,e:30}, {s:31,e:45}, {s:46,e:60}, {s:61,e:75}]; for(let c=0; c<5; c++) { const colNums = []; while(colNums.length < 5) { const num = Math.floor(Math.random() * (cols[c].e - cols[c].s + 1)) + cols[c].s; if(!colNums.includes(num)) colNums.push(num); } card.push(colNums); } card[2][2] = 'FREE'; setPlayerCard(card); setHasClaimed(false); };
            const checkBingo = useMemo(() => { if (playerCard.length === 0 || !gameState) return false; const isMarked = (r, c) => { const v = playerCard[c][r]; return v === 'FREE' || gameState.history.includes(v); }; for(let i=0; i<5; i++) { if([0,1,2,3,4].every(x => isMarked(i, x))) return true; if([0,1,2,3,4].every(x => isMarked(x, i))) return true; } if([0,1,2,3,4].every(i => isMarked(i, i))) return true; if([0,1,2,3,4].every(i => isMarked(i, 4-i))) return true; return false; }, [playerCard, gameState]);
            useEffect(() => { if (checkBingo && !hasClaimed) { confetti({ particleCount: 150 }); updateCredits(200); setHasClaimed(true); } }, [checkBingo]);
            if(!gameState) return <div className="text-center mt-10 text-white">Loading Room...</div>;
            return (
                <div className="space-y-6 animate-in zoom-in"><div className="flex justify-between items-center text-sm"><button onClick={onLeave} className="text-slate-400 hover:text-white">‚Üê ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á</button><span className="text-crypto-accent font-bold">ROOM: {gameState.name}</span></div><div className="glass-panel p-8 text-center relative overflow-hidden"><div className="absolute top-0 right-0 p-2 opacity-20"><Icons.Bingo className="w-16 h-16"/></div><div className="text-7xl font-tech font-bold text-white drop-shadow-[0_0_10px_rgba(0,243,255,0.8)]">{gameState.currentNumber || '--'}</div><div className="text-xs text-slate-500 font-mono tracking-widest mt-2">LUCKY NUMBER</div></div>{userProfile.uid === gameState.hostId ? (<div className="glass-panel p-6 border-crypto-primary/30"><div className="text-xs text-crypto-primary mb-3 tracking-widest">HOST CONTROLS</div><div className="grid grid-cols-2 gap-4"><button onClick={generateNumber} className="bg-white text-black font-bold py-3 rounded hover:scale-105 transition-transform">‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</button><button onClick={toggleAutoPlay} className={`border border-white/20 py-3 rounded transition-all ${isAutoPlaying ? 'bg-crypto-accent text-black animate-pulse' : 'text-slate-300'}`}>{isAutoPlaying ? 'AUTO ON' : 'AUTO PLAY'}</button><button onClick={() => {if(confirm('Reset?')) roomRef.update({currentNumber:null, history:[]})}} className="col-span-2 py-2 text-xs text-red-500 border border-red-500/30 rounded hover:bg-red-500/10">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</button></div></div>) : (<div className="glass-panel p-6 text-center">{playerCard.length === 0 ? (<button onClick={buyCard} className="bg-crypto-accent text-black font-bold py-4 px-10 rounded-full hover:shadow-[0_0_20px_rgba(0,243,255,0.4)] transition-all">‡∏ã‡∏∑‡πâ‡∏≠‡∏ï‡∏±‡πã‡∏ß (50)</button>) : (<div>{checkBingo && <div className="text-2xl font-bold text-yellow-400 mb-4 animate-bounce">BINGO! +200</div>}<div className="grid grid-cols-5 gap-2 aspect-square mb-4">{playerCard.map((col, c) => (<div key={c} className="flex flex-col gap-2">{col.map((val, r) => { const marked = val === 'FREE' || gameState.history.includes(val); return <div key={r} className={`flex-1 flex items-center justify-center font-bold text-sm rounded ${marked ? 'bg-crypto-primary text-white shadow-glow' : 'bg-white/5 text-slate-500'}`}>{val === 'FREE' ? '‚òÖ' : val}</div> })}</div>))}</div><button onClick={buyCard} className="text-xs text-slate-400 hover:text-white border-b border-slate-600">‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏ö‡πÉ‡∏´‡∏°‡πà</button></div>)}</div>)}<div className="glass-panel p-4"><div className="text-[10px] text-slate-500 mb-2 uppercase">History</div><div className="flex flex-wrap gap-1 h-12 overflow-hidden">{(gameState.history || []).map((n, i) => <span key={i} className="text-xs text-slate-300 bg-white/5 px-1 rounded">{n}</span>)}</div></div></div>
            );
        }

        // --- MAIN APP ---
        function App() {
            const [userProfile, setUserProfile] = useState(null);
            const [userData, setUserData] = useState(null);
            const [activePlayers, setActivePlayers] = useState([]);
            const [bgm, setBgm] = useState(false);
            const [screen, setScreen] = useState('lobby'); 
            const [showInv, setShowInv] = useState(false);
            const [showShop, setShowShop] = useState(false);
            const [currentRoomId, setCurrentRoomId] = useState(null);
            const [pendingRequests, setPendingRequests] = useState([]);
            const [myRequest, setMyRequest] = useState(null);

            const usersRef = useMemo(() => db && APP_ID ? db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bingo_users') : null, [db, APP_ID]);
            const requestsRef = useMemo(() => db && APP_ID ? db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('bingo_requests') : null, [db, APP_ID]);
            const audioRef = useRef(new Audio(BGM_URL));

            useEffect(() => {
                if(bgm) { audioRef.current.loop = true; audioRef.current.play().catch(()=>{}); }
                else audioRef.current.pause();
            }, [bgm]);

            useEffect(() => {
                const init = async () => { if (!auth.currentUser) await auth.signInAnonymously(); };
                init();
            }, []);

            // Data Sync
            useEffect(() => {
                if(!userProfile || !usersRef) return;
                const unsubMe = usersRef.doc(userProfile.uid).onSnapshot(d => d.exists && setUserData(d.data()));
                // Client-side sorting for users
                const unsubAll = usersRef.onSnapshot(s => {
                    const users = s.docs.map(d => ({id:d.id, ...d.data()}));
                    users.sort((a,b) => (b.joinedAt?.seconds || 0) - (a.joinedAt?.seconds || 0));
                    setActivePlayers(users.slice(0, 50));
                });
                
                let unsubRequests;
                if (userProfile.role === 'host') {
                    unsubRequests = requestsRef.onSnapshot(s => setPendingRequests(s.docs.map(d => ({id:d.id, ...d.data()}))));
                } else {
                    unsubRequests = requestsRef.onSnapshot(s => {
                        const req = s.docs.map(d => ({id:d.id, ...d.data()})).find(d => d.userId === userProfile.uid);
                        setMyRequest(req || null);
                    });
                }
                return () => { unsubMe(); unsubAll(); unsubRequests && unsubRequests(); };
            }, [userProfile, usersRef]);

            const updateCredits = async (amt) => {
                await usersRef.doc(userProfile.uid).update({ credits: firebase.firestore.FieldValue.increment(amt) });
            };

            const requestCredits = async () => {
                if (myRequest) return;
                await requestsRef.add({ userId: userProfile.uid, name: userProfile.name, amount: 200, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            };

            const approveRequest = async (req) => {
                const batch = db.batch();
                batch.update(usersRef.doc(req.userId), { credits: firebase.firestore.FieldValue.increment(req.amount) });
                batch.delete(requestsRef.doc(req.id));
                await batch.commit();
            };

            const logout = () => {
                setBgm(false);
                setUserProfile(null);
                setUserData(null);
                setScreen('lobby');
            };

            if (!userProfile) return <AuthScreen onJoin={(uid, name, role) => setUserProfile({uid, name, role})} db={db} />;
            if (!userData) return <div className="flex h-screen items-center justify-center text-crypto-accent font-tech tracking-widest">LOADING NEURAL LINK...</div>;

            const getFrameStyle = (frameId) => SHOP_ITEMS.find(i => i.id === frameId)?.css || '';
            const getTitleStyle = (titleId) => SHOP_ITEMS.find(i => i.id === titleId)?.css || 'text-slate-300';

            return (
                <div className="max-w-6xl mx-auto p-4 pb-20 text-slate-200 font-sans">
                    {showInv && <InventoryModal userData={userData} userProfile={userProfile} db={db} onClose={()=>setShowInv(false)} />}
                    {showShop && <ShopModal userData={userData} userProfile={userProfile} db={db} currentAppId={APP_ID} credits={userData.credits} inventory={userData.inventory} equipped={userData.equipped} onClose={()=>setShowShop(false)} updateCredits={updateCredits} />}

                    <header className="flex justify-between items-center mb-8 glass-panel p-4 sticky top-4 z-50">
                        <div className="flex items-center gap-4 cursor-pointer" onClick={()=>setScreen('profile')}>
                            <div className={`w-12 h-12 rounded-lg flex items-center justify-center bg-black border border-white/20 text-white font-bold text-xl ${getFrameStyle(userData.equipped?.frame)}`}>
                                {userData.username.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <h2 className={`font-bold text-lg ${getTitleStyle(userData.equipped?.title)}`}>{userData.username}</h2>
                                <div className="text-xs text-crypto-accent font-mono">{userData.credits.toLocaleString()} SAT</div>
                            </div>
                        </div>
                        <div className="flex gap-2">
                             {screen !== 'lobby' && <button onClick={()=>setScreen('lobby')} className="p-2 bg-white/10 rounded hover:bg-white/20"><Icons.Home className="w-5 h-5"/></button>}
                             <button onClick={()=>setShowShop(true)} className="p-2 bg-white/10 rounded hover:bg-white/20"><Icons.Shopping className="w-5 h-5"/></button>
                             <button onClick={()=>setBgm(!bgm)} className={`p-2 rounded ${bgm?'text-neon-blue':'text-slate-500'}`}>{bgm?<Icons.Music className="w-5 h-5"/>:<Icons.MusicOff className="w-5 h-5"/>}</button>
                             <button onClick={logout} className="p-2 bg-red-500/20 text-red-500 rounded"><Icons.Logout className="w-5 h-5"/></button>
                        </div>
                    </header>

                    {screen === 'lobby' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-in fade-in">
                            <div onClick={()=>setScreen('rooms')} className="game-card p-6 h-48 flex flex-col items-center justify-center border-blue-500/30">
                                <Icons.Bingo className="w-16 h-16 text-blue-400 mb-4"/>
                                <h3 className="text-xl font-bold">BINGO HALL</h3>
                                <p className="text-xs text-slate-400">Multiplayer Live</p>
                            </div>
                            <div onClick={()=>setScreen('runner')} className="game-card p-6 h-48 flex flex-col items-center justify-center border-cyan-500/30">
                                <Icons.Run className="w-16 h-16 text-cyan-400 mb-4"/>
                                <h3 className="text-xl font-bold">CYBER RUN</h3>
                                <p className="text-xs text-slate-400">Endless Runner</p>
                            </div>
                            <div onClick={()=>setScreen('namtao')} className="game-card p-6 h-48 flex flex-col items-center justify-center border-red-500/30">
                                <Icons.Dice className="w-16 h-16 text-red-400 mb-4"/>
                                <h3 className="text-xl font-bold">NAM TAO</h3>
                                <p className="text-xs text-slate-400">Cyber Casino</p>
                            </div>
                            
                            <div className="md:col-span-2 lg:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                                <div className="h-64"><Leaderboard users={activePlayers} /></div>
                                <div className="h-64"><ChatRoom userProfile={userProfile} db={db} /></div>
                            </div>
                        </div>
                    )}

                    {screen === 'rooms' && <BingoLobby userProfile={userProfile} userData={userData} db={db} onClose={()=>setScreen('lobby')} onJoinRoom={(rid)=>{setCurrentRoomId(rid); setScreen('bingo_room');}} />}
                    {screen === 'bingo_room' && <BingoRoom roomId={currentRoomId} userProfile={userProfile} userData={userData} db={db} currentAppId={APP_ID} updateCredits={updateCredits} onLeave={()=>{setCurrentRoomId(null); setScreen('rooms');}} />}
                    {screen === 'runner' && <CyberRunner userData={userData} updateCredits={updateCredits} onClose={()=>setScreen('lobby')} />}
                    {screen === 'namtao' && <NamTaoPuPla userData={userData} updateCredits={updateCredits} onClose={()=>setScreen('lobby')} />}
                    {screen === 'profile' && <UserProfile userData={userData} userProfile={userProfile} db={db} currentAppId={APP_ID} onClose={()=>setScreen('lobby')} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
